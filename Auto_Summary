# existing data = file database
# new data = data that use for update
# final data = ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏° + ‡∏Å‡∏≤‡∏£ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏à‡∏≤‡∏Å new data
import pandas as pd
from google.colab import files
from datetime import datetime
import openpyxl # Ensure openpyxl is imported for ExcelWriter engine

# Key Customers
key_customers_list = [
    "100241", "100244", "100252", "100337", "100550", "100578", "100579", "100599", "100711", "100747",
    "100768", "100798", "100842", "100900", "100958", "101164", "101223", "101259", "101309", "101359",
    "101361", "101363", "101508", "101511", "101516", "101546", "101728", "101781", "101787", "101840",
    "101957", "102004", "102101", "102127", "102148", "102204", "102246", "102293", "104523", "104655",
    "104931", "105129", "105140", "101386", "104085"
]

print("Upload Updated Data file")
uploaded_old = files.upload()
update_filename = next(iter(uploaded_old)) #‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏ôcollab
existing_data = pd.read_excel(update_filename) #Read file

print("Upload All Project Data file")
uploaded_new = files.upload()
new_filename = next(iter(uploaded_new))
new_data = pd.read_excel(new_filename, sheet_name='All Project Data')

#‡∏™‡∏£‡πâ‡∏≤‡∏á col ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
cols_total = new_data.shape[1] #‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏Ç‡∏≠‡∏á DataFrame new_data
cols_main = new_data.iloc[:, 0:26] #‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
cols_extra = new_data.iloc[:, 103:110] if cols_total >= 110 else pd.DataFrame()
#‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πà ‚Üí ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà 103 ‡∏ñ‡∏∂‡∏á 109 (‡∏£‡∏ß‡∏° 7 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)
#‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 110 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á cols_extra ‡πÄ‡∏õ‡πá‡∏ô DataFrame ‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‡πÅ‡∏ó‡∏ô ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà error‡∏ï‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á new data

new_data = pd.concat([cols_main, cols_extra], axis=1) #sum cols

# ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î
rename_cols = {
    "Winnner Value": "Winner Value",
    "WinnnerValue": "Winner Value",
    "WinnerValue": "Winner Value",
    "Project ID": "ProjectID",
    "Project Id": "ProjectID",
    "projectid": "ProjectID",
    "Status Running_Status": "StatusRunning_Status",

    "Winer Name": "WinnerName",
    "WinerName": "WinnerName",
    "Winner Name ": "WinnerName",
    "Winnername": "WinnerName",
    "Winer Date": "WinnerDate",
    "WinerDate": "WinnerDate",
    "Winer Value": "Winner Value",
    "WinerValue": "Winner Value",
    "Winner Value ": "Winner Value",
    "Winnervalue": "Winner Value",
}

# ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô columns Index ‡πÄ‡∏õ‡πá‡∏ô string ‡∏Å‡πà‡∏≠‡∏ô strip
new_data.columns = new_data.columns.astype(str).str.strip() # strip
new_data = new_data.rename(columns=rename_cols) #‡πÉ‡∏ä‡πâ rename() ‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏ß‡πâ‡πÉ‡∏ô dictionary rename_cols
new_data["Budget"] = new_data["Budget"].astype(str).str.replace(',', '').str.replace(' ', '').astype(float)
new_data["Date"] = pd.to_datetime(new_data["Date"], errors='coerce').dt.strftime('%Y-%m-%d')
new_data_filtered = new_data[new_data["Budget"] >= 10000000]

# ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Budget >= 10 ‡∏•‡πâ‡∏≤‡∏ô ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠
existing_data.columns = existing_data.columns.astype(str).str.strip()  # ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô
existing_data = existing_data.rename(columns=rename_cols)  # ‡πÅ‡∏Å‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á
if "Budget" in existing_data.columns:
    existing_data["Budget"] = existing_data["Budget"].astype(str).str.replace(',', '').str.replace(' ', '').astype(float)
    existing_data = existing_data[existing_data["Budget"] >= 10000000].copy()
    existing_data["Date"] = pd.to_datetime(existing_data["Date"], errors='coerce').dt.strftime('%Y-%m-%d')

# Ensure columns are in the desired order and only include those present after renaming
desired_order = [
    "Date", "ProjectID", "Procurement Method", "Subject", "Location", "Owner", "Province", "Region",
    "Budget", "TOR", "Type", "Bid document Start", "Bid document End", "BiddingDate", "RobotWorking",
    "Sale Owner Name", "WinnerName", "WinnerDate", "Winner Value", "PurchaseDoc", "Contract e-GP",
    "Contract Number", "SignDate", "Contract End Date", "StatusDate", "StatusRunning_Status", # ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß
    "SalesPersonCode", "CustomerGroup", "CustomerCode", "CustomerName", "Document Link", "Robot Tracking Status"
]

if existing_data.empty or "ProjectID" not in existing_data.columns: #‡∏ñ‡πâ‡∏≤‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏î‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏´‡∏ô‡∏∂‡πà‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á ‚Üí ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á existing_data ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
    desired_order_filtered = [col for col in desired_order if col in new_data_filtered.columns] # ‡∏™‡∏£‡πâ‡∏≤‡∏á DataFrame ‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏° desired_order
    existing_data = pd.DataFrame(columns=desired_order_filtered) # ‡∏™‡∏£‡πâ‡∏≤‡∏á existing_data ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏û‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏õ‡∏•‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï


# ‡πÉ‡∏ä‡πâ .copy() ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏≤‡∏à‡∏≤‡∏Ådesired_order ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏±‡∏ß‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠
new_data_filtered = new_data_filtered[[col for col in desired_order if col in new_data_filtered.columns]].copy() # ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏° desired_order ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ rename ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß
existing_data = existing_data[[col for col in desired_order if col in existing_data.columns]].copy()

# ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô KeyError: 'ProjectID' ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ rename (Use for check)
if "ProjectID" not in new_data_filtered.columns or "ProjectID" not in existing_data.columns:
    raise ValueError("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 'ProjectID' ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå")

# check ‡∏ß‡πà‡∏≤‡∏°‡∏µ ProjectID ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡πá‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô index
existing_data = existing_data.set_index("ProjectID")
new_data_filtered = new_data_filtered.set_index("ProjectID")

# ‡∏£‡∏ß‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á DataFrame ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ update ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
all_columns = existing_data.columns.union(new_data_filtered.columns) #‡∏£‡∏ß‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á existing_data ‡πÅ‡∏•‡∏∞ new_data_filtered ‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô (‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô)
existing_data = existing_data.reindex(columns=all_columns) #‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ DataFrame ‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏≤‡∏° all_columns
new_data_filtered = new_data_filtered.reindex(columns=all_columns)

existing_data.update(new_data_filtered)
#‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô existing_data ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà index (ProjectID) ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô ‡∏Å‡∏±‡∏ö new_data_filtered
#‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô‡∏ö‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á ‚Üí ‡∏Ñ‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏∞‡πÑ‡∏õ‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤ or ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (NaN) ‡πÉ‡∏ô new_data_filtered ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏ó‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°

new_only = new_data_filtered.loc[~new_data_filtered.index.isin(existing_data.index)].reset_index().copy() #‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞ ProjectID ‡πÉ‡∏ô new_data_filtered ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô existing_data ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
new_only["CustomerCode_str"] = new_only["CustomerCode"].fillna(0).astype(int).astype(str) # ‡∏´‡∏≤ row ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÉ‡∏ô existing_data ‡πÅ‡∏•‡∏∞ reset index ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á CustomerCode_str ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô CustomerCode ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µNaN

# ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ new_only ‡∏ó‡∏µ‡πà reset index ‡πÅ‡∏•‡πâ‡∏ß (ProjectID ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)
# ‡∏ï‡πâ‡∏≠‡∏á set_index "ProjectID" ‡πÉ‡∏´‡πâ new_only ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô concat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ align ‡∏ï‡∏≤‡∏° ProjectID
final_data = pd.concat([existing_data, new_only.set_index("ProjectID")]).reset_index().copy()

# ‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏° desired_order ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
final_data = final_data[[col for col in desired_order if col in final_data.columns]]

# ‡∏™‡∏£‡πâ‡∏≤‡∏á CustomerCode_str ‡πÉ‡∏ô final_data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÉ‡∏ô tracking functions
final_data["CustomerCode_str"] = final_data["CustomerCode"].fillna(0).astype(int).astype(str)

today_str = datetime.now().strftime('%Y-%m-%d')
updated_file = f"Updated_Data_{today_str}.xlsx"
final_data.to_excel(updated_file, index=False)
files.download(updated_file) #Update file dowload

#--------------------------------------------------Summary-----------------------------------------------------------#

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô tracking ‡∏Ç‡∏≠‡∏áall data(‡πÉ‡∏ä‡πâ row[col_name] ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏±‡∏á reset_index)
def create_tracking(df):
    tracking_rows = []
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ CustomerCode_str
    if "CustomerCode_str" not in df.columns:
         df["CustomerCode_str"] = df["CustomerCode"].fillna(0).astype(int).astype(str)

    # ‡πÉ‡∏ä‡πâ 'CustomerCode_str' ‡πÅ‡∏•‡∏∞ 'CustomerName' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
    # ‡πÉ‡∏ä‡πâ dropna=False ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏ß‡∏° NaN ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢
    grouped = df.groupby(["CustomerCode_str", "CustomerName"], sort=False, dropna=False) #‡∏à‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏ÅCustomerCode ‡πÅ‡∏•‡∏∞name
    for (code, name), group in grouped: #‡∏ß‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞customercode
        # ‡∏õ‡∏£‡∏±‡∏ö code ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ CustomerCode' ‡∏ñ‡πâ‡∏≤ code ‡πÄ‡∏õ‡πá‡∏ô '0'
        display_code = code if code != '0' else "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ CustomerCode"
        tracking_rows.append({
            "CustomerCode": display_code,
            "CustomerName": name,
            "ProjectID": f"Total Projects: {len(group)}",
            "Winner Value": "",
            "Contract Number": "",
            "SignDate": "",
            "Contract End Date": "",
        })
        # ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ô customer code
        for index, row in group.iterrows():
            # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô row data ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô dictionary ‡πÅ‡∏ó‡∏ô list
            tracking_rows.append({
                "CustomerCode": "",
                "CustomerName": "",
                "ProjectID": row.get("ProjectID", ""), # ‡πÉ‡∏ä‡πâ .get() ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
                "Winner Value": row.get("Winner Value", ""),
                "Contract Number": row.get("Contract Number", ""),
                "SignDate": row.get("SignDate", ""),
                "Contract End Date": row.get("Contract End Date", "")
            })
    # ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á DataFrame
    return pd.DataFrame(tracking_rows, columns=["CustomerCode", "CustomerName", "ProjectID", "Winner Value", "Contract Number", "SignDate", "Contract End Date"])

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡∏∏‡∏õ ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏£‡∏ö ‡∏ó‡∏±‡πâ‡∏á‡∏°‡∏µ-‡πÑ‡∏°‡πà‡∏°‡∏µ Winner ‡∏Ç‡∏≠‡∏ásummary (Revised to be cleaner and handle '0' code)
def create_grouped_tracking(df, customer_type):
    tracking_list = []
    # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ CustomerCode_str
    if "CustomerCode_str" not in df.columns:
         df["CustomerCode_str"] = df["CustomerCode"].fillna(0).astype(int).astype(str)

    # ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° CustomerCode_str ‡πÅ‡∏•‡∏∞ CustomerName
    grouped = df.groupby(["CustomerCode_str", "CustomerName"], dropna=False, sort=False) # ‡πÉ‡∏ä‡πâ dropna=False ‡πÅ‡∏•‡∏∞ sort=False

    for (code, name), group in grouped:
        # ‡∏Å‡∏£‡∏≠‡∏á row ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô "Winner Value" ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠ NaN
        group_with_winner = group[group.get("Winner Value", pd.NA).notna() & (group.get("Winner Value", "") != "")]
        has_winner_projects = len(group_with_winner) > 0

        # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î code ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏±‡∏ö
        display_code = code if code != '0' else "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ CustomerCode"
        display_count = len(group_with_winner) if has_winner_projects else len(group) # ‡∏ô‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏°‡∏µ Winner ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ, otherwise ‡∏ô‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î

        # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏•‡∏∏‡πà‡∏°
        tracking_list.append({
            "CustomerCode": display_code,
            "CustomerName": name,
            "ProjectID": f"Total Projects: {display_count}",
            "Winner Value": "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Winner Name" if not has_winner_projects else "",
            "Contract Number": "",  # ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Contract Number
            "SignDate": "" ,# ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SignDate
            "Contract End Date": ""# ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Contract End Date
        })

        # ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞ row ‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏™‡∏î‡∏á (‡∏°‡∏µ winner ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ winner)
        rows_to_iterate = group_with_winner if has_winner_projects else group
        for index, row in rows_to_iterate.iterrows():
             # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô row data ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô dictionary ‡πÅ‡∏ó‡∏ô list
            tracking_list.append({
                "CustomerCode": "", # CustomerCode
                "CustomerName": "", # CustomerName
                "ProjectID": row.get("ProjectID", ""),
                "Winner Value": row.get("Winner Value", ""),
                "Contract Number": row.get("Contract Number", ""),
                "SignDate": row.get("SignDate", ""),
                "Contract End Date": row.get("Contract End Date", ""),
             })
    # ‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á DataFrame ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö create_tracking
    # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ DataFrame ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    return pd.DataFrame(tracking_list, columns=[
        "CustomerCode", "CustomerName", "ProjectID", "Winner Value","Contract Number", "SignDate", "Contract End Date"  ])

# Create Customer Tracking (from all final_data)
# final_data already has CustomerCode_str
customer_tracking = create_tracking(final_data)

# Create Key Customer Tracking (from filtered final_data)
# Create key customer data by copying rows where "CustomerCode_str" is in the list
key_customers_data_for_tracking = final_data[final_data["CustomerCode_str"].isin(key_customers_list)].copy()
key_customer_tracking = create_tracking(key_customers_data_for_tracking)

#Difference data
# ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ (‡∏à‡∏≤‡∏Å existing_data)
prev_project_count = len(existing_data)
prev_customers_count = existing_data["CustomerCode"].fillna(0).astype(int).astype(str).nunique()
prev_key_customers_count = existing_data[
    existing_data["CustomerCode"].fillna(0).astype(int).astype(str).isin(key_customers_list)
]["CustomerCode"].nunique()

# ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ (‡∏à‡∏≤‡∏Å final_data)
new_project_count = len(final_data)
new_customers_count = final_data["CustomerCode"].fillna(0).astype(int).astype(str).nunique()
new_key_customers_count = final_data[
    final_data["CustomerCode"].fillna(0).astype(int).astype(str).isin(key_customers_list)
]["CustomerCode"].nunique()

# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á
diff_project = new_project_count - prev_project_count
diff_customers = new_customers_count - prev_customers_count
diff_key_customers = new_key_customers_count - prev_key_customers_count

#--------------------------------------------------Create Excel-----------------------------------------------------------#

# ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Excel ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏µ‡∏ó
report_file = f"Customer_Tracking_Report_{today_str}.xlsx"
with pd.ExcelWriter(report_file, engine="openpyxl") as writer:
    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Sheet "Summary Report"
    summary_data = pd.DataFrame({
        "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£": [
            "Total Projects (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ì ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)",
            "Total Key Customers Projects  (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á Nila ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ì ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)",
            "Total Other Customers Projects (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏ì ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)"
        ],
        "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô": [
            f"{new_project_count} (+{diff_project})",
            f"{new_key_customers_count} (+{diff_key_customers})",
            f"{new_customers_count} (+{diff_customers})"
        ]
    })
    summary_data.to_excel(writer, sheet_name="Summary Report", startrow=0, index=False)

    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Key Projects Tracking (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô new_only) ‡πÉ‡∏ô Summary Report
    # ‡πÉ‡∏ä‡πâ .copy() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô SettingWithCopyWarning
    key_projects_new = new_only[new_only["CustomerCode_str"].isin(key_customers_list)].copy()
    key_tracking_summary = create_grouped_tracking(key_projects_new, "Key Customers Projects (New)")
    startrow_kp = 5 # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Key Projects Tracking ‡πÉ‡∏ô Summary Report
    key_tracking_summary.to_excel(writer, sheet_name="Summary Report", startrow=startrow_kp, index=False)

    # ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Other Projects Tracking (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô new_only) ‡πÉ‡∏ô Summary Report
    # ‡πÉ‡∏ä‡πâ .copy() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô SettingWithCopyWarning
    other_projects_new = new_only[~new_only["CustomerCode_str"].isin(key_customers_list)].copy()
    other_tracking_summary = create_grouped_tracking(other_projects_new, "Other Customers Projects (New)")
    startrow_op = startrow_kp + len(key_tracking_summary) + 3 # ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÅ‡∏ñ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Other Projects Tracking
    other_tracking_summary.to_excel(writer, sheet_name="Summary Report", startrow=startrow_op, index=False)
    # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Sheet "All Data"
    final_data.to_excel(writer, sheet_name="All Data", index=False)

    # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Sheet "Customer Tracking"
    customer_tracking.to_excel(writer, sheet_name="Customer Tracking", index=False)

    # ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Sheet "Key Customers Tracking"
    key_customer_tracking.to_excel(writer, sheet_name="Key Customers Tracking", index=False)

files.download(report_file)

print("üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:")
print(f"‚ûï Total Projects : {new_project_count} ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (+{diff_project})")
print(f"üéØ Total Key Customers Projects : {new_key_customers_count} ‡∏£‡∏≤‡∏¢ (+{diff_key_customers})")
print(f"üìã Total Other Customers Projects : {new_customers_count} ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (+{diff_customers})")
print(f"\n ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‚úÖ")
print(f"\n Have a nice day‚ú®")
